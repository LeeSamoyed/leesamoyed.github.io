# MySQL是怎样运行的 从根儿上理解MySQL

## 楔子

## 装作自己是个小白 —— 初识MySQL

### 请求流程

以比较复杂的查询请求为例来展示大致的过程：

- 连接管理
    - 查询缓存：缓存共享（请求的结果并不会直接销毁，而是会缓存起来，如果不同用户用了同样的命令则会直接共享结果，但是字符匹配很麻烦；同时系统相关、变量函数相关等结果不会存储；值得注意这些缓存对应的表等如果存在修改之类的也会缓存失效，这个是由MySQL的缓存系统直接监视的）
    - 语法解析
    - 查询优化：MySQL本身会优化我们的复杂语法（如外连接转化为内连接、表达式简化、子查询转为连接、优化表的查询顺序等等；EXPLAIN语句可以用于查看某个语句的执行计划）

- 解析与优化

- 存储引擎：逻辑概念和物理地址的对应，寻常所写的语句属于server，到了MySQL真的去获取的时候就到了存储引擎层，存储引擎不止一个，它对应了很多很多不同的存储结构，实现不同的功能，采用的存储算法也不同。因此在查询优化之后，就会生成执行计划调用底层存储引擎提供的接口真实的获取数据。值得一提的是server层与存储引擎层的交互，一般以记录为单位。它是一条记录一条记录来判断的。

上述中，server层在判断某条记录符合要求之后，其实是先将其发送到一个缓冲区，待到该缓冲区满了，才向客户端发送真正的记录。该缓冲区大小由系统变量net_buffer_length控制。

## MySQL调控按钮 —— 启动选项和系统变量

- 启动选项，配置文件
- 系统变量
- 状态变量（只能看，不能改）

## 字符集和比较规则

计算机中实际存储的是二进制，显示的是字符串，为了做到这一点需要建立字符串和二进制之间的映射关系。字符到二进制是编码，二进制到字符是解码。

### MySQL字符集

### MySQL比较规则

可能包含多种比较规则（不同国家区分读音等，因此比较规则很多，但是都是以字符集名称+比较偏向命名，例如uft8_polish_ci是波兰语不区分大小写的比较规则）

### MySQL的服务器级别，数据库级别，表级别，列级别字符集和比较规则划分

服务器 > 数据库  > 表 > 列 （每一个都以上一个为默认）

### 字符集转换过程

需要明白的是：客户端在编码请求字符串时实际使用的字符集，与服务器在接收到一个字节序列后认为该字节序列所采用的编码字符集，是两个独立的字符集。

- character_set_client：服务器认为请求是按照该系统变量指定的字符集进行编码的
- character_set_connection：服务器在处理请求时，会把请求字节序列从character_set_client转换为character_set_connection
- character_set_results：服务器采用该系统变量指定的字符集对返回给客户端的字符串进行编码

### 明白

- 客户端发送的请求字节序列是采用哪种字符集进行编码的：这一步骤取决于操作系统当前所使用的字符集（对于Windows系统，还与客户端启动时的设置的启动选项有关）；
- 服务器接受到请求字节序列后会认为它是采用哪种字符集进行编码的：这一步骤取决于系统变量character_set_client的值；
- 服务器在运行过程中会把请求的字节序列转换为以哪种字符集编码的字节序列：这一步骤取决于系统变量character_set_connection的值；
- 服务器在向客户端返回字节序列时，是采用哪种字符集进行编码的：这一步骤取决于系统变量character_set_results的值；
- 客户端在收到响应的字节序列后，是怎么把它们写到命令行窗口中的：这一步骤取决于操作系统当前使用的字符集（对于Windows系统，还与客户端启动时的设置的启动选项有关）；

## 从一条记录说起 —— Inno记录存储结构

Inno在读取数据的时候并不是直接从硬盘读取（读内存比读硬盘快特别多），Inno采取的方式是，将数据划分为若干项，以页作为硬盘和内存之间交互的基本单位。InnoDB中页的大小一般为16KB（这个大小在启动时可以手动设定）。也就是在一般情况下，一次最少从硬盘读取16KB的内容到内存中，一次最少把内存中16KB内容刷新到磁盘中。

### 行格式

- COMPACT
    - 记录的额外信息
        - 变长字段长度列表
        - NULL值列表
        - 记录头信息
            - DB_ROW_ID
            - DB_TRX_ID
            - DB_ROLL_PTR

    - 记录的真实信息
    
    - CHAR(M)列的存储格式

- REDUNDANT

    - 字段长度偏移列表（偏移，就是记录到每个字节总的，现在的偏移减去前一个的偏移就是当前某个字符占据的字节大小）
    - 记录头信息
    - 1byte_offs_flag(表示用几个字节存储偏移量)
    - 没有NULL值表，但是偏移量值的第一个位作为NULL值比特位
    - CHAR(M) 为字符乘以M，例如uft8就是30字节

- 溢出列（如果溢出，就在末尾加指针，真实数据处只会保留部分数据，其余的页地址靠指针）

- DYNAMIC & COMPRESSED行格式

    - DYNAMIC是把所有的真实数据都存储到了溢出页。COMPRESSED相比于DYNAMIC会对也看进行压缩


## 盛放记录的大盒子 —— InnoDB数据页结构

## 快速查询的秘籍 —— B+树索引

## B+树索引的作用

## 数据的家 —— MySQL的数据目录

## 存放页面的大池子 —— InnoDB的表空间

## 条条大路通罗马 —— 单表访问方法

## 两个表的亲密接触 —— 连接的原理

## 谁最便宜就选谁 —— 基于成本的优化

## 兵马未动，粮草先行 —— InnoDB统计数据是如何收集的

## 基于规则的优化（内含子查询优化二三事）

## 查询优化的百科全书 —— EXPLAIN详解

## 神兵利器 —— optimizer trace的神奇功效

## 调节硬盘和CPU的矛盾 —— InnoDB的Buffer Pool

## 从猫爷借钱说起 —— 事务简介

## 说过的话就一定要做到 —— redo日志

## 后悔了怎么办 —— undo日志

## 一条记录的多幅面孔 —— 事务隔离级别的MVCC

## 工作面试老大难 —— 锁